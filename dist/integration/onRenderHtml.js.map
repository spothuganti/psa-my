{"version":3,"file":"onRenderHtml.js","sources":["../../src/utils/assert.ts","../../src/utils/getTagAttributesString.ts","../../src/integration/onRenderHtml.ts"],"sourcesContent":["export function assert(condition: unknown): asserts condition {\r\n  if (condition) return\r\n  throw new Error('You stumbled upon a vike-vue bug, reach out on GitHub.')\r\n}\r\n","export { getTagAttributesString }\r\nexport type { TagAttributes }\r\n\r\ntype TagAttributes = Record<string, string | number | boolean | undefined | null>\r\n\r\nfunction getTagAttributesString(tagAttributes: TagAttributes): string {\r\n  const tagAttributesString = Object.entries(tagAttributes)\r\n    .filter(([_key, value]) => value !== false && value !== null && value !== undefined)\r\n    .map(([key, value]) => `${ensureIsValidAttributeName(key)}=${JSON.stringify(String(value))}`)\r\n    .join(' ')\r\n  if (tagAttributesString.length === 0) return ''\r\n  return ` ${tagAttributesString}`\r\n}\r\n\r\nfunction ensureIsValidAttributeName(str: string): string {\r\n  if (/^[a-z][a-z0-9\\-]*$/i.test(str) && !str.endsWith('-')) return str\r\n  throw new Error(`Invalid HTML tag attribute name ${JSON.stringify(str)}`)\r\n}\r\n","// https://vike.dev/onRenderHtml\r\nexport { onRenderHtml }\r\n\r\nimport { dangerouslySkipEscape, escapeInject } from 'vike/server'\r\nimport type { OnRenderHtmlAsync, PageContextServer } from 'vike/types'\r\nimport { App } from 'vue'\r\nimport { type SSRContext, renderToNodeStream, renderToString, renderToWebStream } from 'vue/server-renderer'\r\nimport { callCumulativeHooks } from '../utils/callCumulativeHooks.js'\r\nimport { assert } from '../utils/assert.js'\r\nimport { createVueApp } from './createVueApp.js'\r\nimport { getHeadSetting } from './getHeadSetting.js'\r\nimport { getTagAttributesString, type TagAttributes } from '../utils/getTagAttributesString.js'\r\nimport type { PageContextInternal } from '../types/PageContext.js'\r\n\r\nconst onRenderHtml: OnRenderHtmlAsync = async (\r\n  pageContext: PageContextServer & PageContextInternal,\r\n): ReturnType<OnRenderHtmlAsync> => {\r\n  const { pageHtml, fromHtmlRenderer } = await getPageHtml(pageContext)\r\n\r\n  pageContext.isRenderingHead = true\r\n  const headHtml = await getHeadHtml(pageContext)\r\n  pageContext.isRenderingHead = false\r\n\r\n  const { bodyHtmlBegin, bodyHtmlEnd } = await getBodyHtmlBoundary(pageContext)\r\n\r\n  const { htmlAttributesString, bodyAttributesString } = getTagAttributes(pageContext)\r\n\r\n  // Not needed on the client-side, thus we remove it to save KBs sent to the client\r\n  delete pageContext._configFromHook\r\n\r\n  const documentHtml = escapeInject`<!DOCTYPE html>\r\n    <html${dangerouslySkipEscape(htmlAttributesString)}>\r\n      <head>\r\n        <meta charset=\"UTF-8\" />\r\n        ${headHtml}\r\n      </head>\r\n      <body${dangerouslySkipEscape(bodyAttributesString)}>\r\n        ${bodyHtmlBegin}\r\n        <div id=\"app\">${pageHtml}</div>\r\n        ${bodyHtmlEnd}\r\n      </body>\r\n    </html>`\r\n\r\n  return {\r\n    documentHtml,\r\n    pageContext: {\r\n      enableEagerStreaming: true,\r\n      fromHtmlRenderer,\r\n    },\r\n  }\r\n}\r\n\r\nexport type PageHtmlStream = ReturnType<typeof renderToNodeStream> | ReturnType<typeof renderToWebStream>\r\nasync function getPageHtml(pageContext: PageContextServer) {\r\n  let pageHtml: ReturnType<typeof dangerouslySkipEscape> | PageHtmlStream | string = ''\r\n  pageContext.ssrContext = {}\r\n  const fromHtmlRenderer: PageContextServer['fromHtmlRenderer'] = {}\r\n\r\n  let app: App | undefined\r\n  if (\r\n    // Whether SSR is enabled\r\n    !!pageContext.Page\r\n  ) {\r\n    const { app: app_ } = await createVueApp(pageContext, true, 'Page')\r\n    app = app_\r\n    pageContext.app = app\r\n  }\r\n\r\n  // - We call onBeforeRenderHtml() right before rendering, so that pageContext.app is available to onBeforeRenderHtml()\r\n  //   - https://github.com/vikejs/vike-vue/issues/141\r\n  await callCumulativeHooks(pageContext.config.onBeforeRenderHtml, pageContext)\r\n\r\n  if (pageContext.Page) {\r\n    assert(app)\r\n\r\n    if (!pageContext.config.stream) {\r\n      const pageHtmlString = await renderToStringWithErrorHandling(app, pageContext.ssrContext)\r\n      pageContext.pageHtmlString = pageHtmlString\r\n      pageHtml = dangerouslySkipEscape(pageHtmlString)\r\n    } else {\r\n      const pageHtmlStream =\r\n        pageContext.config.stream === 'web'\r\n          ? renderToWebStreamWithErrorHandling(app, pageContext.ssrContext)\r\n          : renderToNodeStreamWithErrorHandling(app, pageContext.ssrContext)\r\n      pageContext.pageHtmlStream = pageHtmlStream\r\n      pageHtml = pageHtmlStream\r\n    }\r\n\r\n    // TODO/breaking-change: always call onAfterRenderHtml()\r\n    //  - I.e. don't call it inside this `if (!!pageContext.Page)` block.\r\n    //  - Tell users to use `!!pageContext.Page` if they want to apply the hook only for SSR.\r\n    //    - Already done: https://vike.dev/onAfterRenderHtml\r\n    const afterRenderResults = await callCumulativeHooks(pageContext.config.onAfterRenderHtml, pageContext)\r\n    Object.assign(fromHtmlRenderer, ...afterRenderResults)\r\n  }\r\n  return { pageHtml, fromHtmlRenderer }\r\n}\r\n\r\nasync function getHeadHtml(pageContext: PageContextServer & PageContextInternal) {\r\n  pageContext._headAlreadySetWrapper = { val: true }\r\n\r\n  const title = getHeadSetting<string | null>('title', pageContext)\r\n  const favicon = getHeadSetting<string | null>('favicon', pageContext)\r\n  const description = getHeadSetting<string | null>('description', pageContext)\r\n  const image = getHeadSetting<string | null>('image', pageContext)\r\n\r\n  const titleTags = !title ? '' : escapeInject`<title>${title}</title><meta property=\"og:title\" content=\"${title}\">`\r\n  const faviconTag = !favicon ? '' : escapeInject`<link rel=\"icon\" href=\"${favicon}\" />`\r\n  const descriptionTags = !description\r\n    ? ''\r\n    : escapeInject`<meta name=\"description\" content=\"${description}\"><meta property=\"og:description\" content=\"${description}\">`\r\n  const imageTags = !image\r\n    ? ''\r\n    : escapeInject`<meta property=\"og:image\" content=\"${image}\"><meta name=\"twitter:card\" content=\"summary_large_image\">`\r\n  const viewportTag = dangerouslySkipEscape(getViewportTag(getHeadSetting<Viewport>('viewport', pageContext)))\r\n\r\n  let headElementHtml: ReturnType<typeof dangerouslySkipEscape> | string = ''\r\n  const { app } = await createVueApp(pageContext, true, 'Head')\r\n  headElementHtml = dangerouslySkipEscape(await renderToStringWithErrorHandling(app))\r\n\r\n  const headHtml = escapeInject`\r\n    ${titleTags}\r\n    ${viewportTag}\r\n    ${headElementHtml}\r\n    ${faviconTag}\r\n    ${descriptionTags}\r\n    ${imageTags}\r\n  `\r\n  return headHtml\r\n}\r\n\r\nasync function getBodyHtmlBoundary(pageContext: PageContextServer) {\r\n  const bodyHtmlBegin = dangerouslySkipEscape(\r\n    (await callCumulativeHooks(pageContext.config.bodyHtmlBegin, pageContext)).join(''),\r\n  )\r\n\r\n  // we define this hook here so that it doesn't need to be exported by vike-vue\r\n  const defaultTeleport = `<div id=\"teleported\">${pageContext.ssrContext!.teleports?.['#teleported'] ?? ''}</div>`\r\n  const bodyHtmlEndHooks = [defaultTeleport, ...(pageContext.config.bodyHtmlEnd ?? [])]\r\n  const bodyHtmlEnd = dangerouslySkipEscape((await callCumulativeHooks(bodyHtmlEndHooks, pageContext)).join(''))\r\n\r\n  return { bodyHtmlBegin, bodyHtmlEnd }\r\n}\r\n\r\nfunction getTagAttributes(pageContext: PageContextServer) {\r\n  let lang = getHeadSetting<string | null>('lang', pageContext)\r\n  // Don't set `lang` to its default value if it's `null` (so that users can set it to `null` in order to remove the default value)\r\n  if (lang === undefined) lang = 'en'\r\n\r\n  const bodyAttributes = mergeTagAttributesList(getHeadSetting<TagAttributes[]>('bodyAttributes', pageContext))\r\n  const htmlAttributes = mergeTagAttributesList(getHeadSetting<TagAttributes[]>('htmlAttributes', pageContext))\r\n\r\n  const bodyAttributesString = getTagAttributesString(bodyAttributes)\r\n  const htmlAttributesString = getTagAttributesString({ ...htmlAttributes, lang: lang ?? htmlAttributes.lang })\r\n\r\n  return { htmlAttributesString, bodyAttributesString }\r\n}\r\nfunction mergeTagAttributesList(tagAttributesList: TagAttributes[] = []) {\r\n  const tagAttributes: TagAttributes = {}\r\n  tagAttributesList.forEach((tagAttrs) => Object.assign(tagAttributes, tagAttrs))\r\n  return tagAttributes\r\n}\r\n\r\nasync function renderToStringWithErrorHandling(app: App, ctx?: SSRContext) {\r\n  let returned = false\r\n  let err: unknown\r\n  // Workaround: Vue's renderToString() swallows errors in production https://github.com/vuejs/core/issues/7876\r\n  // Let's eventually use app.config.throwUnhandledErrorInProduction instead (recently released in vue@3.5).\r\n  app.config.errorHandler = (err_) => {\r\n    if (returned) {\r\n      console.error(err_)\r\n    } else {\r\n      err = err_\r\n    }\r\n  }\r\n  const appHtml = await renderToString(app, ctx)\r\n  returned = true\r\n  if (err) throw err\r\n  return appHtml\r\n}\r\n\r\nfunction renderToNodeStreamWithErrorHandling(app: App, ctx?: SSRContext) {\r\n  let returned = false\r\n  let err: unknown\r\n  app.config.errorHandler = (err_) => {\r\n    if (returned) {\r\n      console.error(err_)\r\n    } else {\r\n      err = err_\r\n    }\r\n  }\r\n  const appHtml = renderToNodeStream(app, ctx)\r\n  returned = true\r\n  if (err) throw err\r\n  return appHtml\r\n}\r\n\r\nfunction renderToWebStreamWithErrorHandling(app: App, ctx?: SSRContext) {\r\n  let returned = false\r\n  let err: unknown\r\n  app.config.errorHandler = (err_) => {\r\n    if (returned) {\r\n      console.error(err_)\r\n    } else {\r\n      err = err_\r\n    }\r\n  }\r\n  const appHtml = renderToWebStream(app, ctx)\r\n  returned = true\r\n  if (err) throw err\r\n  return appHtml\r\n}\r\n\r\nexport type Viewport = 'responsive' | number | null\r\nfunction getViewportTag(viewport: Viewport | undefined): string {\r\n  if (viewport === 'responsive' || viewport === undefined) {\r\n    // `user-scalable=no` isn't recommended anymore:\r\n    //   - https://stackoverflow.com/questions/22354435/to-user-scalable-no-or-not-to-user-scalable-no/22544312#comment120949420_22544312\r\n    return '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">'\r\n  }\r\n  if (typeof viewport === 'number') {\r\n    return `<meta name=\"viewport\" content=\"width=${viewport}\">`\r\n  }\r\n  return ''\r\n}\r\n"],"names":[],"mappings":"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"}